<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerVsTeam</title>
    <style>
        .win-row {
            background-color: #d0f0c0; /* light green */
        }

        th {
            cursor: pointer;
            background-color: #f0f0f0;
        }

        th:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <h1>PlayerVsTeam</h1>
    <div>
        <label for="playerName">Player Name:</label>
        <input type="text" id="playerName" placeholder="Enter player name">
    </div>
    <div>
        <label for="teamVs">Opponent Team:</label>
        <input type="text" id="teamVs" placeholder="Enter opponent team">
    </div>
    <button onclick="handleSearch()">Search</button>

    <div id="results"></div>

    <script>
        let globalData = [];

        async function fetchData(playerName, teamVs) {
            const limit = 500;
            let offset = 0;
            let allData = [];

            while (true) {
                const url = `https://lol.fandom.com/api.php?action=cargoquery&tables=ScoreboardPlayers&fields=Name,PlayerWin,GameId,Team,TeamVs,DateTime_UTC&where=Name%20LIKE%20'${encodeURIComponent(playerName)}'&limit=${limit}&format=json&origin=*&offset=${offset}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    if (data.cargoquery.length === 0) break;

                    const currentBatch = data.cargoquery.map(item => item.title);
                    allData = allData.concat(currentBatch);
                    if (currentBatch.length < limit) break;

                    offset += limit;
                } catch (error) {
                    console.error(`Error fetching data: ${error.message}`);
                    break;
                }
            }

            const filteredData = allData.filter(item => item.TeamVs === teamVs);

            // Sort by DateTime UTC
            filteredData.sort((a, b) => new Date(a["DateTime UTC"]) - new Date(b["DateTime UTC"]));

            // Update values
            filteredData.forEach(item => {
                if (item.PlayerWin === "Yes") {
                    item.PlayerWin = "Win";
                    item.PlayerLose = "";
                } else if (item.PlayerWin === "No") {
                    item.PlayerLose = "Lose";
                    item.PlayerWin = "";
                } else {
                    item.PlayerLose = "";
                }
            });

            globalData = filteredData; // Save for sorting
            displayData(filteredData);
        }

        function displayData(data) {
            const resultDiv = document.getElementById("results");
            resultDiv.innerHTML = "";

            if (data.length === 0) {
                resultDiv.innerHTML = "<p>No results found.</p>";
                return;
            }

            // Summary
            const playerWin = data.filter(item => item.PlayerWin === "Win").length;
            const playerLose = data.filter(item => item.PlayerLose === "Lose").length;

            const summary = document.createElement("p");
            summary.innerHTML = `Summary:<br>PlayerWin = ${playerWin}<br>PlayerLose = ${playerLose}`;
            resultDiv.appendChild(summary);

            // Table
            const table = document.createElement("table");
            table.border = "1";

            const headers = ["No.", "DateTime UTC", "GameId", "Team", "TeamVs", "PlayerWin", "PlayerLose", "Name"];
            const headerRow = table.createTHead().insertRow();

            headers.forEach((header, index) => {
                const th = document.createElement("th");
                th.textContent = header;
                th.onclick = () => sortTableByColumn(index);
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();

            data.forEach((item, index) => {
                const row = tbody.insertRow();
                if (item.PlayerWin === "Win") row.classList.add("win-row");

                const rowData = [
                    index + 1,
                    item["DateTime UTC"],
                    item.GameId,
                    item.Team,
                    item.TeamVs,
                    item.PlayerWin,
                    item.PlayerLose,
                    item.Name
                ];

                rowData.forEach(cellData => {
                    const cell = row.insertCell();
                    cell.textContent = cellData !== undefined && cellData !== null ? cellData : "N/A";
                });
            });

            resultDiv.appendChild(table);
        }

        let sortOrder = {};

        function sortTableByColumn(columnIndex) {
            const headers = ["No.", "DateTime UTC", "GameId", "Team", "TeamVs", "PlayerWin", "PlayerLose", "Name"];
            const key = headers[columnIndex];
            const isAsc = !sortOrder[key];
            sortOrder = { [key]: isAsc };

            const sortedData = [...globalData].sort((a, b) => {
                const aVal = columnIndex === 0 ? globalData.indexOf(a) + 1 : getValueForKey(a, key);
                const bVal = columnIndex === 0 ? globalData.indexOf(b) + 1 : getValueForKey(b, key);

                if (key === "DateTime UTC") {
                    return isAsc ? new Date(aVal) - new Date(bVal) : new Date(bVal) - new Date(aVal);
                }

                return isAsc
                    ? aVal.toString().localeCompare(bVal.toString())
                    : bVal.toString().localeCompare(aVal.toString());
            });

            displayData(sortedData);
        }

        function getValueForKey(item, key) {
            if (key === "No.") return globalData.indexOf(item) + 1;
            return item[key] || "";
        }

        function handleSearch() {
            const playerName = document.getElementById("playerName").value.trim();
            const teamVs = document.getElementById("teamVs").value.trim();

            if (!playerName || !teamVs) {
                alert("Please enter both the player's name and the opponent team.");
                return;
            }

            fetchData(playerName, teamVs);
        }
    </script>
</body>
</html>
